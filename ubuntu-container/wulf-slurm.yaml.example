apiVersion: apps/v1
kind: Deployment
metadata:
  name: wulf-slurm
spec:
  replicas: 1
  selector:
    matchLabels:
      app: wulf-slurm
  template:
    metadata:
      labels:
        app: wulf-slurm
    spec:
      hostNetwork: true
      containers:
      - name: wulf-slurm
        image: docker.io/library/wulf-slurm:latest
        imagePullPolicy: Never # Important!
        securityContext:
          runAsUser: 0
          runAsGroup: 0
          privileged: true
            #ports:
            #  - containerPort: 67
            #    protocol: UDP
            #  - containerPort: 68
            #    protocol: UDP
            #  - containerPort: 69
            #    protocol: UDP
            #  - containerPort: 80
            #    protocol: TCP
            #  - containerPort: 2049
            #    protocol: TCP
            #  - containerPort: 2049
            #    protocol: UDP
            #  - containerPort: 6817
            #    protocol: TCP
            #  - containerPort: 9873
            #    protocol: TCP
        volumeMounts:
          - name: wulf-vol
            mountPath: /vol
        env:
          - name: WW_IPADDR
            value: {{ YOUR FLOATING IP }}
          - name: WW_NETMASK
            value: {{ YOUR NETMASK }}
          - name: WW_NETWORK
            value: {{ FIRST ADDRESS IN YOUR NETWORK }}
          - name: WW_DHCP_START
            value: {{ FIRST IP FOR DHCP LEASES }}
          - name: WW_DHCP_END
            value: {{ LAST IP FOR DHCP LEASES }}
          - name: WW_NET_PREFIX
            value: "{{ NETWORK PREFIX LENGTH AS STRING }}"
          - name: SLURM_SLURMCTLD_HOST
            value: {{ YOUR FLOATING IP }}
          - name: SLURM_SLURMDBD_HOST
            value: {{ YOUR FLOATING IP }}
          - name: SLURM_STORAGE_HOST
            value: {{ YOUR MARIA/MYSQL HOST IP }}
          - name: SERVE_NFS
            value: "1"
          - name: SLURM_STORAGE_PASS
            valueFrom:
              secretKeyRef:
                name: slurm-storage-secret
                key: SLURM_STORAGE_PASS
      volumes:
        - name: wulf-vol
          hostPath:
            path: /srv/vol
            type: Directory

---
apiVersion: v1
kind: Service
metadata:
  name: wulf-slurm-service
spec:
  selector:
    app: wulf-slurm
  ports:
  - port: 80
    targetPort: 80
    protocol: TCP
    name: web
  - port: 6817
    targetPort: 6817
    protocol: TCP
    name: wulf1
  - port: 9873
    targetPort: 9873
    protocol: TCP
    name: wulf2
  - port: 2049
    targetPort: 2049
    protocol: TCP
    name: nfs-tcp
  - port: 2049
    targetPort: 2049
    protocol: UDP
    name: nfs-udp
  - port: 67
    targetPort: 67
    protocol: UDP
    name: dhcp-udp1
  - port: 68
    targetPort: 68
    protocol: UDP
    name: dhcp-udp2
  - port: 69
    targetPort: 68
    protocol: UDP
    name: tftp
  type: LoadBalancer
